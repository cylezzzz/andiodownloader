<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>ANDIO Downloader</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0e17;--panel:linear-gradient(145deg,#131820 0%,#0d1117 100%);
  --brd:rgba(255,255,255,.08);--txt:#e8ecf2;--muted:#8b92a8;
  --accent:#ff3366;--accent2:#ff6b95;--accent-glow:rgba(255,51,102,.35);
  --ok:#00ff88;--warn:#ffaa00;--err:#ff4444;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
body{overflow:hidden}
.bg{position:fixed;inset:0;pointer-events:none;opacity:.12;z-index:0;background:
  radial-gradient(40rem 40rem at 20% 30%, var(--accent-glow) 0%, transparent 60%),
  radial-gradient(40rem 40rem at 80% 70%, rgba(0,255,136,.25) 0%, transparent 60%);
  animation:bgfloat 22s ease-in-out infinite}
@keyframes bgfloat{0%,100%{transform:translate(0,0)}50%{transform:translate(16px,-12px)}}

/* Topbar */
.topbar{position:relative;z-index:5;display:flex;gap:16px;align-items:center;
  padding:12px 18px;background:rgba(13,17,25,.75);backdrop-filter:blur(14px) saturate(160%);
  border-bottom:1px solid var(--brd);box-shadow:0 4px 24px rgba(0,0,0,.4)}
.logo{display:flex;gap:10px;align-items:center;font-weight:700}
.logo .icon{width:32px;height:32px;border-radius:10px;display:grid;place-items:center;
  background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 0 0 1px rgba(255,255,255,.12),0 8px 22px var(--accent-glow)}
.tabs{margin-left:auto;display:flex;gap:8px;padding:4px;border:1px solid var(--brd);border-radius:12px;background:rgba(0,0,0,.25)}
.tab{border:0;border-radius:10px;padding:10px 18px;background:transparent;color:var(--muted);
  font:500 14px/1 'Inter';cursor:pointer;transition:.25s}
.tab.active{color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 6px 18px var(--accent-glow)}
.tab:not(.active):hover{background:rgba(255,255,255,.06);color:var(--txt)}

/* Layout */
.main{position:relative;z-index:1;height:calc(100vh - 58px);padding:14px;gap:14px;display:grid;grid-template-columns: 1fr 5px 380px;}
.splitter{width:5px;cursor:col-resize;background:transparent;border-radius:3px}
.splitter:hover{background:var(--accent)}
.panel{display:flex;flex-direction:column;min-height:0;background:var(--panel);border:1px solid var(--brd);border-radius:18px;box-shadow:0 10px 28px rgba(0,0,0,.35);overflow:hidden}
.hidden{display:none !important}
.header{padding:16px 18px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.02)}
.header h2{font-size:18px;font-weight:600;display:flex;gap:10px;align-items:center}
.header .right{display:flex;gap:8px;align-items:center}
.btn{border:1px solid var(--brd);border-radius:10px;background:rgba(255,255,255,.06);color:var(--txt);padding:10px 14px;font:500 13px/1 'Inter';cursor:pointer;transition:.2s}
.btn:hover{background:rgba(255,255,255,.1)}
.btn.primary{border:0;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;box-shadow:0 6px 18px var(--accent-glow)}
.btn.warn{border-color:rgba(255,170,0,.35);background:rgba(255,170,0,.12)}
.btn.ghost{background:transparent}

/* Forms */
.section{padding:18px;border-bottom:1px solid var(--brd)}
.group{margin-bottom:14px}
.label{font:600 12px/1 'Inter';letter-spacing:.4px;text-transform:uppercase;color:var(--muted);margin-bottom:8px}
input,textarea,select{width:100%;border:1px solid var(--brd);border-radius:12px;background:rgba(0,0,0,.28);color:var(--txt);padding:12px 14px;font:500 14px/1.2 'Inter';outline:none;transition:.2s}
textarea{min-height:110px;resize:vertical}
input:focus,textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}

/* Table / Queue */
.scroll{flex:1;min-height:0;overflow:auto;padding:18px}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th{padding:10px 12px;text-align:left;color:var(--muted);font:600 11px/1 'Inter';text-transform:uppercase;border-bottom:1px solid var(--brd)}
.table td{padding:12px;border-top:1px solid transparent;border-bottom:1px solid transparent}
.row{background:rgba(255,255,255,.03);border-radius:12px}
.name{display:flex;flex-direction:column}
.url{font-size:11px;color:var(--muted);max-width:340px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pbar{height:8px;border-radius:999px;background:rgba(255,255,255,.1);overflow:hidden}
.fill{height:100%;width:0;background:linear-gradient(90deg,#4facfe,#00f2fe);transition:width .2s}
.info{display:flex;justify-content:space-between;color:var(--muted);font-size:11px;margin-top:6px}

/* badges */
.badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.08);font:600 12px 'Inter'}
.dot{width:8px;height:8px;border-radius:999px;background:var(--muted);box-shadow:0 0 10px currentColor}
.dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.err{background:var(--err)}

/* cards grid */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.card{background:rgba(255,255,255,.03);border:1px solid var(--brd);border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:10px}
.card:hover{transform:translateY(-1px);background:rgba(255,255,255,.05);transition:.2s}
.card .meta{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;border-top:1px solid var(--brd);padding-top:10px}
.actions{display:flex;gap:8px}

/* chat right */
.chat{display:flex;flex-direction:column;min-height:0}
.chat .status{padding:14px;border-bottom:1px solid var(--brd);display:grid;gap:8px;background:rgba(255,255,255,.02)}
.sitem{display:flex;gap:10px;align-items:center}
.slabel{font:600 13px 'Inter';color:var(--muted)}
.messages{flex:1;min-height:0;overflow:auto;display:flex;flex-direction:column;gap:12px;padding:14px}
.msg{display:flex;gap:10px;animation:fade .2s}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg.user{flex-direction:row-reverse}
.avatar{width:30px;height:30px;border-radius:8px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),var(--accent2))}
.msg.user .avatar{background:linear-gradient(135deg,#556,#334)}
.bubble{max-width:78%;padding:12px 14px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid var(--brd)}
.msg.user .bubble{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:0}
.time{font-size:10px;color:var(--muted);margin-top:4px}
.composer{border-top:1px solid var(--brd);padding:12px;display:flex;flex-direction:column;gap:8px;background:rgba(0,0,0,.25)}
.controls{display:flex;gap:8px;align-items:center}
textarea.input{min-height:56px;max-height:140px;resize:none}
.send{align-self:flex-end}
.typing{display:flex;gap:5px}
.dotT{width:8px;height:8px;border-radius:999px;background:var(--muted);animation:typing 1.2s infinite}
.dotT:nth-child(2){animation-delay:.2s}.dotT:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.5}30%{transform:translateY(-8px);opacity:1}}
</style>
</head>
<body>
<div class="bg"></div>

<!-- TOP -->
<div class="topbar">
  <div class="logo"><div class="icon">‚ö°</div><div>ANDIO Downloader</div></div>
  <div class="tabs">
    <button class="tab active" id="tabDashboard">üìä Dashboard</button>
    <button class="tab" id="tabDownloads">üì• Downloads</button>
    <button class="tab" id="tabWizard">ü™Ñ Wizard</button>
    <button class="tab" id="tabLibrary">üß© Mediathek</button>
  </div>
</div>

<!-- MAIN -->
<div class="main" id="layout">
  <!-- LEFT: PAGES -->
  <section class="panel" id="pageDashboard">
    <div class="header"><h2>üìä Dashboard</h2></div>
    <div class="scroll" id="dashWrap">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr));">
        <div class="card"><div class="badge"><span class="dot ok"></span>Downloads</div><div style="font:700 32px 'Inter'" id="dashDownloads">0</div></div>
        <div class="card"><div class="badge"><span class="dot ok"></span>Addons</div><div style="font:700 32px 'Inter'" id="dashAddons">0</div></div>
        <div class="card"><div class="badge"><span class="dot warn"></span>Wizard Runs</div><div style="font:700 32px 'Inter'" id="dashWizard">0</div></div>
        <div class="card"><div class="badge"><span class="dot ok" id="aiDot"></span>AI Status</div><div style="font:700 32px 'Inter'" id="dashAI">Bereit</div></div>
      </div>
      <div style="height:14px"></div>
      <div class="card"><div style="font:600 14px 'Inter';margin-bottom:8px">Letzte Aktivit√§ten</div><div id="recentActivity" style="display:flex;flex-direction:column;gap:8px;color:var(--muted);font-size:13px"></div></div>
    </div>
  </section>

  <section class="panel hidden" id="pageDownloads">
    <div class="header">
      <h2>üì• Download Manager</h2>
      <div class="right"><div class="badge"><span class="dot" id="dlDot"></span><span id="dlStatus">Bereit</span></div></div>
    </div>
    <div class="section">
      <div class="group"><div class="label">Download Links</div><textarea id="links" placeholder="Eine URL pro Zeile ‚Ä¶"></textarea></div>
      <div class="group">
        <div class="label">Zielordner</div>
        <div style="display:flex;gap:8px"><input id="outDir" placeholder="W√§hlen ‚Ä¶" readonly><button class="btn" id="choose">üìÅ W√§hlen</button></div>
      </div>
      <div style="display:flex;gap:8px"><button class="btn primary" id="btnStart">‚ñ∂Ô∏è Starten</button><button class="btn" id="btnAbort">‚èπÔ∏è Abbrechen</button></div>
    </div>
    <div class="scroll">
      <table class="table">
        <thead><tr><th>#</th><th>Datei</th><th>Gr√∂√üe</th><th>Speed</th><th>Fortschritt</th></tr></thead>
        <tbody id="queue"></tbody>
      </table>
    </div>
  </section>

  <section class="panel hidden" id="pageWizard">
    <div class="header">
      <h2>ü™Ñ Addon Wizard</h2>
      <div class="right"><div class="badge"><span class="dot" id="wizDot"></span><span id="wizStatus">Inaktiv</span></div></div>
    </div>
    <div class="section">
      <div class="group"><div class="label">Zielordner (fix)</div>
        <div style="display:flex;gap:8px"><input id="wizDir" readonly><button class="btn" id="wizOpen">üìÇ √ñffnen</button></div>
      </div>
      <div class="group"><div class="label">Addon-Name</div><input id="wizName" placeholder="z. B. metadataScraper"></div>
      <div class="group"><div class="label">Beschreibung / Anforderungen</div><textarea id="wizDesc" placeholder="Beschreibe, was das Addon tun soll ‚Ä¶"></textarea></div>
      <div style="display:flex;gap:8px"><button class="btn primary" id="wizCreate">‚ú® Addon erzeugen & speichern</button><button class="btn" id="wizReset">Zur√ºcksetzen</button></div>
    </div>
    <div class="scroll"><div class="card"><div style="font:600 14px 'Inter';margin-bottom:8px">Wizard Log</div><pre id="wizLog" style="white-space:pre-wrap;line-height:1.5;color:var(--muted)"></pre></div></div>
  </section>

  <section class="panel hidden" id="pageLibrary">
    <div class="header">
      <h2>üß© Addon Mediathek</h2>
      <div class="right"><button class="btn" id="libOpen">üìÇ Ordner √∂ffnen</button><button class="btn primary" id="libReload">Aktualisieren</button></div>
    </div>
    <div class="scroll"><div class="grid" id="addonGrid"></div></div>
  </section>

  <!-- SPLITTER -->
  <div class="splitter" id="split"></div>

  <!-- RIGHT: CHAT -->
  <aside class="panel chat" id="chat">
    <div class="header"><h2>ü§ñ AI Assistant</h2></div>
    <div class="status">
      <div class="sitem"><span class="dot" id="sDl"></span><span class="slabel" id="sDlT">Downloads inaktiv</span></div>
      <div class="sitem"><span class="dot" id="sWiz"></span><span class="slabel" id="sWizT">Wizard inaktiv</span></div>
      <div class="sitem"><span class="dot ok" id="sModel"></span><span class="slabel" id="sModelT">Modell bereit</span></div>
    </div>
    <div class="messages" id="msgs">
      <div class="msg"><div class="avatar">ü§ñ</div><div><div class="bubble">Hallo! Ich bleibe rechts immer sichtbar. Frag mich etwas oder starte einen Download/Wizard.</div><div class="time">Jetzt</div></div></div>
    </div>
    <div class="composer">
      <div class="controls"><select id="model" style="flex:1">
        <option value="mistral7b" selected>mistral7b</option>
        <option value="qwen2.5:3b">qwen2.5:3b</option>
        <option value="llama3:8b">llama3:8b</option>
        <option value="codellama">codellama</option>
      </select></div>
      <div style="display:flex;gap:8px;align-items:flex-end">
        <textarea class="input" id="chatInput" placeholder="Stelle eine Frage ‚Ä¶ (Enter = senden)"></textarea>
        <button class="btn primary send" id="send">üì§</button>
      </div>
    </div>
  </aside>
</div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const hasAPI = typeof window !== "undefined" && window.api && typeof window.api.invoke === "function";
  const ADDONS_DIR = "G:\\\\andiodownloader\\\\andiodownloader\\\\addons"; // fix

  /* Tabs */
  const pages={dashboard:$("pageDashboard"),downloads:$("pageDownloads"),wizard:$("pageWizard"),library:$("pageLibrary")};
  const tabs={dashboard:$("tabDashboard"),downloads:$("tabDownloads"),wizard:$("tabWizard"),library:$("tabLibrary")};
  function show(which){ Object.values(pages).forEach(p=>p.classList.add("hidden")); pages[which].classList.remove("hidden");
    Object.values(tabs).forEach(t=>t.classList.remove("active")); tabs[which].classList.add("active");
    if(which==="library") loadLibrary(); }
  tabs.dashboard.onclick=()=>show("dashboard"); tabs.downloads.onclick=()=>show("downloads"); tabs.wizard.onclick=()=>show("wizard"); tabs.library.onclick=()=>show("library"); show("dashboard");

  /* Splitter */
  const split=$("split"), main=$("layout"); let drag=false;
  split.addEventListener("mousedown",()=>{drag=true;document.body.style.cursor="col-resize";});
  document.addEventListener("mousemove",e=>{ if(!drag) return; const r=main.getBoundingClientRect(); const w=Math.max(320,Math.min(560, r.right - e.clientX)); main.style.gridTemplateColumns=`1fr 5px ${w}px`;});
  document.addEventListener("mouseup",()=>{drag=false;document.body.style.cursor="";});

  /* Helpers */
  const fmtB=n=>{if(!n)return"0 B";const u=["B","KB","MB","GB"];let i=0;while(n>=1024&&i<u.length-1){n/=1024;i++}return`${n.toFixed(1)} ${u[i]}`};
  const now=()=>new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
  function activity(t){const el=$("recentActivity");const d=document.createElement("div");d.textContent="‚Ä¢ "+t;el.prepend(d);}

  /* Chat */
  const msgs=$("msgs"), chatInput=$("chatInput"), send=$("send"), modelSel=$("model");
  function addMsg(type,text){const n=document.createElement("div");n.className=`msg ${type==='user'?'user':''}`;
    n.innerHTML=`<div class="avatar">${type==='user'?'üë§':'ü§ñ'}</div><div><div class="bubble">${text}</div><div class="time">${now()}</div></div>`;
    msgs.appendChild(n); msgs.scrollTop=msgs.scrollHeight;}
  function typing(on){let t=$("typing"); if(on){ if(t) return; const n=document.createElement("div"); n.className="msg"; n.id="typing"; n.innerHTML=`<div class="avatar">ü§ñ</div><div class="bubble"><div class="typing"><div class="dotT"></div><div class="dotT"></div><div class="dotT"></div></div></div>`; msgs.appendChild(n); msgs.scrollTop=msgs.scrollHeight;}
    else if(t){t.remove();}}
  chatInput.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send.click();}});
  send.onclick=async()=>{const text=chatInput.value.trim(); if(!text) return; chatInput.value=""; addMsg("user",text); $("sModel").classList.add("warn"); $("sModelT").textContent=`${modelSel.value} arbeitet`; typing(true);
    try{const reply = hasAPI ? await window.api.invoke("chat:ask",{model:modelSel.value,prompt:text}) : `[${modelSel.value}] Echo: ${text}`;
      typing(false); addMsg("bot",reply); $("sModel").classList.remove("warn"); $("sModel").classList.add("ok"); $("sModelT").textContent="Modell bereit";}
    catch(e){typing(false); addMsg("bot","‚ùå Fehler: "+(e.message||e)); $("sModel").classList.remove("warn"); $("sModel").classList.add("err"); $("sModelT").textContent="Modellfehler";}};

  /* Downloads */
  const qBody=$("queue"), dlDot=$("dlDot"), dlStatus=$("dlStatus");
  $("choose").onclick=async()=>{const res=hasAPI?await window.api.invoke("downloads:chooseDir"): {path:"C:\\\\Users\\\\Public\\\\Downloads"}; if(res?.path) $("outDir").value=res.path;};
  function buildQueue(links){qBody.innerHTML=""; links.forEach((u,i)=>{const name=(u.split("/").pop()||u).split("?")[0]; const tr=document.createElement("tr"); tr.className="row"; tr.innerHTML=`
    <td>${i+1}</td>
    <td class="name"><div>${name||"Datei"}</div><div class="url">${u}</div></td>
    <td id="sz-${i}">‚Äî</td><td id="sp-${i}">‚Äî</td>
    <td><div class="pbar"><div class="fill" id="bar-${i}"></div></div><div class="info"><span id="pc-${i}">0%</span><span id="eta-${i}">‚Äî</span></div></td>`;
    qBody.appendChild(tr);});}
  $("btnStart").onclick=async()=>{const links=$("links").value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); if(!links.length){addMsg("bot","‚ö†Ô∏è Keine Links angegeben.");return;}
    if(!$("outDir").value){addMsg("bot","‚ö†Ô∏è Kein Zielordner gew√§hlt.");return;}
    buildQueue(links); dlDot.classList.add("warn"); dlStatus.textContent="L√§uft ‚Ä¶"; $("sDl").classList.add("warn"); $("sDlT").textContent="Downloads aktiv"; activity(`Start: ${links.length} Downloads`);
    if(hasAPI){
      window.api.on("downloads:state",(s)=>{const w=Math.max(0,Math.min(100,s.pct||0)); const bar=$("bar-"+s.i),pc=$("pc-"+s.i),sz=$("sz-"+s.i),sp=$("sp-"+s.i),eta=$("eta-"+s.i);
        if(bar) bar.style.width=w+"%"; if(pc) pc.textContent=Math.round(w)+"%"; if(sz) sz.textContent=s.total?`${fmtB(s.done)} / ${fmtB(s.total)}`:fmtB(s.done||0); if(sp) sp.textContent=s.speed?`${fmtB(s.speed)}/s`:"‚Äî"; if(eta) eta.textContent=s.eta?`ETA ${s.eta}s`:"‚Äî";});
      await window.api.invoke("downloads:start",{links,outDir:$("outDir").value});
      dlDot.classList.remove("warn"); dlDot.classList.add("ok"); dlStatus.textContent="Abgeschlossen ‚úì"; $("sDl").classList.remove("warn"); $("sDl").classList.add("ok"); $("sDlT").textContent="Downloads fertig"; activity("Downloads abgeschlossen");
    } else {
      // Demo
      for(let i=0;i<links.length;i++){for(let p=0;p<=100;p+=5){$("bar-"+i).style.width=p+"%"; $("pc-"+i).textContent=p+"%"; $("sp-"+i).textContent="500 KB/s"; await new Promise(r=>setTimeout(r,80));} $("sz-"+i).textContent="100.0 MB";}
      dlDot.classList.remove("warn"); dlDot.classList.add("ok"); dlStatus.textContent="Abgeschlossen (Demo) ‚úì"; $("sDl").classList.add("ok"); $("sDlT").textContent="Downloads fertig"; activity("Demo-Downloads abgeschlossen");
    }};
  $("btnAbort").onclick=async()=>{if(hasAPI) await window.api.invoke("downloads:abortAll"); dlDot.classList.remove("warn"); dlDot.classList.add("err"); dlStatus.textContent="Abgebrochen"; $("sDl").classList.add("err"); $("sDlT").textContent="Downloads abgebrochen"; activity("Downloads abgebrochen");};

  /* Wizard ‚Äì KI integriert (nutzt chat:ask; Default mistral7b) */
  $("wizDir").value = ADDONS_DIR.replace(/\\\\/g,"\\");
  $("wizOpen").onclick = async () => { if(hasAPI) await window.api.invoke("shell:openPath",{path:ADDONS_DIR}); };
  $("wizReset").onclick = () => { $("wizName").value=""; $("wizDesc").value=""; $("wizLog").textContent=""; $("wizDot").classList.remove("warn","ok","err"); $("wizStatus").textContent="Inaktiv"; $("sWiz").classList.remove("warn","ok","err"); $("sWizT").textContent="Wizard inaktiv"; };

  $("wizCreate").onclick = async () => {
    const name = $("wizName").value.trim() || ("addon_"+Date.now());
    const desc = $("wizDesc").value.trim();
    if (!desc) { $("wizLog").textContent += "‚ö†Ô∏è Bitte Beschreibung angeben.\n"; return; }

    $("wizDot").classList.add("warn"); $("wizStatus").textContent="KI aktiv ‚Ä¶";
    $("sWiz").classList.add("warn"); $("sWizT").textContent="Wizard aktiv (KI schreibt Code)";
    $("wizLog").textContent += `‚Ä¢ KI wird gefragt (Modell: ${$("model").value||"mistral7b"}) ‚Ä¶\n`;

    let code = "";
    try{
      const prompt = `Erstelle ein JavaScript-Addon f√ºr ANDIO Downloader. Anforderungen:\n${desc}\n\nR√ºckgabe: G√ºltiges CommonJS-Modul mit:\nmodule.exports = { name, version, active, run: async (args)=>{...} };\nKein Kommentar-Spam, klarer Code.`;
      code = hasAPI ? await window.api.invoke("chat:ask",{ model: $("model").value || "mistral7b", prompt }) : `// (Demo)\nmodule.exports={name:"${name}",version:"1.0.0",active:true,run:async(a)=>({ok:true,message:"Demo-Addon l√§uft."})};`;
    }catch(e){ $("wizLog").textContent += "‚ùå KI-Fehler: "+(e.message||e)+"\n"; }

    const safe = name.replace(/[^a-z0-9_\-]/gi,"_");
    const file = `${safe}.js`;
    const content = code.trim() ? code : `module.exports={name:"${safe}",version:"1.0.0",active:true,run:async(a)=>({ok:true})};`;

    try{
      if(hasAPI){
        const res = await window.api.invoke("agent:createFile",{dir:ADDONS_DIR,name:file,content});
        if(!res?.ok) throw new Error(res?.error||"Fehler beim Schreiben");
      }
      $("wizLog").textContent += `‚úÖ Addon gespeichert: ${ADDONS_DIR}\\${file}\n`;
      $("wizDot").classList.remove("warn"); $("wizDot").classList.add("ok"); $("wizStatus").textContent="Fertig";
      $("sWiz").classList.remove("warn"); $("sWiz").classList.add("ok"); $("sWizT").textContent="Wizard abgeschlossen";
      activity(`Addon durch KI erstellt: ${file}`);
      await loadLibrary();
    }catch(e){
      $("wizLog").textContent += `‚ùå Fehler: ${e.message}\n`;
      $("wizDot").classList.remove("warn"); $("wizDot").classList.add("err"); $("wizStatus").textContent="Fehler";
      $("sWiz").classList.remove("warn"); $("sWiz").classList.add("err"); $("sWizT").textContent="Wizard Fehler";
    }
  };

  /* Mediathek */
  $("libOpen").onclick = async () => { if(hasAPI) await window.api.invoke("shell:openPath",{path:ADDONS_DIR}); };
  $("libReload").onclick = () => loadLibrary();

  async function loadLibrary(){
    const grid=$("addonGrid"); grid.innerHTML="";
    let addons=[];
    try{ addons = hasAPI ? await window.api.invoke("addons:list",{dir:ADDONS_DIR}) : null; }catch{}
    if(!Array.isArray(addons)){
      addons = [
        {name:"metadataScraper",version:"1.0.0",active:true,filename:"metadataScraper.js",mtime:Date.now()},
        {name:"filenameNormalizer",version:"0.2.1",active:false,filename:"filenameNormalizer.disabled.js",mtime:Date.now()-3600_000}
      ];
    }
    $("dashAddons").textContent = String(addons.length);

    addons.forEach(a=>{
      const card=document.createElement("div"); card.className="card";
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font:600 16px 'Inter'">üß© ${a.name}</div>
          <div class="badge"><span class="dot ${a.active?'ok':''}"></span>${a.active?'Aktiv':'Inaktiv'}</div>
        </div>
        <div style="color:var(--muted);font-size:13px">Version ${a.version||'1.0.0'}</div>
        <div class="meta"><span>${a.filename||a.name+".js"}</span><span>${new Date(a.mtime||Date.now()).toLocaleString()}</span></div>
        <div class="actions">
          <button class="btn ${a.active?'':'primary'} act">${a.active?'Deaktivieren':'Aktivieren'}</button>
          <button class="btn warn del">L√∂schen</button>
          <button class="btn ghost open">Im Explorer</button>
        </div>`;
      grid.appendChild(card);

      card.querySelector(".act").onclick = async () => {
        const next=!a.active;
        try{
          if(hasAPI) await window.api.invoke("addons:setActive",{dir:ADDONS_DIR,name:a.filename||a.name+".js",active:next});
          a.active=next; loadLibrary(); activity(`Addon ${a.name} ${next?'aktiviert':'deaktiviert'}`);
        }catch(e){ addMsg("bot","‚ùå Addon Toggle: "+(e.message||e)); }
      };
      card.querySelector(".del").onclick = async () => {
        if(!confirm(`Addon "${a.name}" wirklich l√∂schen?`)) return;
        try{ if(hasAPI) await window.api.invoke("addons:delete",{dir:ADDONS_DIR,name:a.filename||a.name+".js"}); activity(`Addon gel√∂scht: ${a.name}`); loadLibrary(); }
        catch(e){ addMsg("bot","‚ùå L√∂schen: "+(e.message||e)); }
      };
      card.querySelector(".open").onclick = async () => { if(hasAPI) await window.api.invoke("shell:openPath",{path:ADDONS_DIR}); };
    });
  }
  loadLibrary();

  /* Dashboard Demo-Counter */
  (function demo(){ let w=0; setInterval(()=>{ $("dashWizard").textContent=String(w++); },6000); })();
})();
</script>
</body>
</html>
